# Story 2.2: Genetic Algorithm Fitness Evaluation

**Status:** Draft

## Goal & Context

**User Story:** As a user, I want the genetic algorithm to evaluate the fitness of each trading strategy in the population based on backtesting metrics so that only the most promising strategies are selected for further evolution, ensuring the system focuses on profitable and robust rules.

**Context:** This story follows GA initialization (Story 2.1) and precedes selection and crossover (Story 2.3). It defines how strategies are assessed using backtesting results, such as Sharpe ratio and drawdown, to assign fitness scores, which guide the GA's evolutionary process and align with the overall goal of discovering effective trading strategies.

## Detailed Requirements

- Implement a fitness evaluation function that runs a quick backtest on each strategy in the population and computes a fitness score based on configurable metrics (e.g., weighted combination of Sharpe ratio, total return, and max drawdown).
- Integrate with the backtesting framework from Epic 3 to simulate trades and gather metrics without full backtest overhead.
- Make fitness calculation parallelizable for efficiency in large populations.
- Allow users to define fitness weights in `config.yaml` (e.g., prioritize Sharpe ratio over total return).
- Log fitness scores for each individual and generation, including reasons for high/low scores.
- Ensure evaluation handles invalid or underperforming strategies gracefully, assigning low fitness without errors.

## Acceptance Criteria (ACs)

- AC1: Each strategy in the population receives a fitness score based on backtesting metrics as defined in the configuration.
- AC2: The evaluation process uses weighted metrics correctly, reflecting user preferences from `config.yaml`.
- AC3: Fitness calculation is efficient, leveraging parallel processing for populations larger than a specified threshold.
- AC4: Logs detail individual fitness scores and key contributing metrics for each strategy.
- AC5: Strategies that violate rules (e.g., excessive drawdown) are penalized with lower fitness scores.
- AC6: The system avoids recomputing evaluations where possible, using cached results if available.
- AC7: Fitness evaluation integrates seamlessly into the GA loop, updating population states accurately.

## Technical Implementation Context

**Guidance:** Use the following details for implementation.

- **Relevant Files:**
  - Files to Create: `src/adaptive_trading_system/ga/fitness.py`, `tests/unit/ga/test_fitness.py`
  - Files to Modify: `src/adaptive_trading_system/ga/engine.py` (incorporate evaluation), `src/adaptive_trading_system/config/settings.py` (add fitness config), `docs/data-models.md` (update BacktestMetrics for fitness use)

- **Key Technologies:**
  - Pandas and NumPy for metric calculations
  - Joblib or concurrent.futures for parallelism

- **API Interactions / SDK Usage:**
  - Call the backtesting engine internally for metric computation.

- **UI/UX Notes:** Log summary statistics of fitness distribution per generation.

- **Data Structures:** Use `BacktestMetrics` to inform fitness scores.

- **Environment Variables:** None specific.

- **Coding Standards Notes:** Ensure fitness functions are idempotent and well-documented with type hints.

## Tasks / Subtasks

- [ ] Define the fitness scoring function with configurable weights.
- [ ] Integrate backtesting for evaluation.
- [ ] Implement parallel evaluation for performance.
- [ ] Add logging and error handling.

## Testing Requirements

- **Unit Tests:** Test fitness calculations on sample strategies.
- **Integration Tests:** Verify evaluation within the GA context.

## Story Wrap Up

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {}
- **Change Log:** {}