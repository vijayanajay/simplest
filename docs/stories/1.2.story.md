# Story 1.2: Historical Data Fetching & Caching

**Status:** Draft

## Goal & Context

**User Story:** As a user, I want the system to reliably fetch historical price and volume data for the specified Indian large/mid-cap NSE stocks over the configured date range so that the backtesting and strategy discovery process has the necessary input data. I also want the system to cache this data efficiently so that subsequent runs using the same data are faster.

**Context:** This story builds upon the system setup (Story 1.1) by implementing the crucial data ingestion layer. It focuses on fetching market data specifically for Indian NSE stocks using `yfinance`, incorporating resilience and a local caching mechanism to improve performance and reliability for repeated runs. This data will be the input for feature generation (Story 1.3) and backtesting (Epic 2).

## Detailed Requirements

- Implement a resilient wrapper around `yfinance` to fetch OHLCV data for NSE equity stocks (symbols ending in `.NS`).
- The wrapper must include retry logic and configurable timeouts for API calls.
- Implement a local caching mechanism for fetched data.
- The cache should use SQLite for metadata (symbol, date range, version) and potentially data chunks.
- Include simple checksums or verification logic for cached data integrity.
- The caching mechanism should support versioning to handle potential future data format changes.
- Handle and report errors gracefully if data fetching fails for a specific stock or date range.
- Ensure the system can handle the volume of data required for multiple stocks over several years.

## Acceptance Criteria (ACs)

- AC1: The system successfully fetches historical OHLCV data for all specified `.NS` stock symbols within the configured date range using the `yfinance` wrapper.
- AC2: The `yfinance` wrapper includes retry logic for failed requests.
- AC3: Fetched data is stored in a local cache.
- AC4: Subsequent runs requesting the same data within the cached range retrieve data from the cache instead of refetching via `yfinance`.
- AC5: The caching mechanism includes metadata allowing verification of cached data validity (e.g., symbol, date range, version, checksum).
- AC6: The system logs clear messages indicating data fetching progress, cache hits, and any fetching errors.
- AC7: The system handles cases where data is partially available or missing for a stock/date range, logging warnings but continuing the run if possible (or failing gracefully if critical data is missing).

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Refer to the linked `docs/` files for broader context if needed.

- **Relevant Files:**
  - Files to Create: `src/adaptive_trading_system/components/data_fetcher.py`, `src/adaptive_trading_system/data/cache/market_data.sqlite` (created by the code), `scripts/manage_data.py` (optional utility for cache management), `tests/unit/components/test_data_fetcher.py`, `tests/integration/test_data_fetching_caching.py`
  - Files to Modify: `src/adaptive_trading_system/config/settings.py` (add data source config), `src/adaptive_trading_system/main.py` (integrate data fetcher), `docs/data-models.md` (define `CachedMarketData` schema), `docs/api-reference.md` (document yfinance usage), `docs/environment-vars.md` (document `CACHE_DB_PATH`), `.gitignore` (ensure cache directory is ignored)
  - _(Hint: See `docs/project-structure.md` for overall layout)_

- **Key Technologies:**
  - Python 3.10+
  - yfinance (0.2.18+)
  - Pandas (for data handling)
  - SQLite (via Python's `sqlite3` module)
  - Pydantic (for config validation)
  - Python `logging` module
  - `tenacity` (optional, for retry logic)
  - _(Hint: See `docs/tech-stack.md` for full list)_

- **API Interactions / SDK Usage:**
  - Use `yfinance` library: `yf.Ticker("SYMBOL.NS").history(start="...", end="...", interval="1d")`.
  - Handle potential `yfinance` errors (e.g., network issues, invalid symbols, no data).
  - Interact with SQLite database using `sqlite3` module for cache operations (connect, cursor, execute, commit, close).
  - _(Hint: See `docs/api-reference.md` for details on external APIs and SDKs)_

- **UI/UX Notes:** ONLY IF THIS IS A UI Focused Epic or Story
  - Log data fetching progress and cache status clearly to the console.

- **Data Structures:**
  - Use Pandas DataFrames for handling OHLCV data fetched from `yfinance`.
  - Define the schema for the SQLite cache table (`cached_market_data`) in `docs/data-models.md`.
  - _(Hint: See `docs/data-models.md` for key project data structures)_

- **Environment Variables:**
  - Support `CACHE_DB_PATH` environment variable to override the cache location specified in config or default.
  - _(Hint: See `docs/environment-vars.md` for all variables)_

- **Coding Standards Notes:**
  - Implement the `yfinance` wrapper with retry logic and error handling.
  - Design the caching logic to check for existing data, fetch if needed, and save to SQLite.
  - Implement checksum/verification logic (e.g., simple row count or hash of key columns).
  - Ensure proper closing of SQLite connections.
  - Use type hints and docstrings.
  - _(Hint: See `docs/coding-standards.md` for full standards)_

## Tasks / Subtasks

- [ ] Implement a basic `yfinance` wrapper to fetch data for a list of symbols and date range.
- [ ] Add retry logic and configurable timeouts to the `yfinance` wrapper.
- [ ] Design the SQLite cache schema (`cached_market_data`) and document it in `docs/data-models.md`.
- [ ] Implement SQLite database connection and table creation logic.
- [ ] Implement cache saving logic (insert data into SQLite).
- [ ] Implement cache loading logic (query data from SQLite).
- [ ] Implement cache validity check (symbol, date range, version, checksum).
- [ ] Integrate cache loading and saving into the data fetching process.
- [ ] Add versioning support to the cache schema and logic.
- [ ] Implement error handling for fetching failures (log warnings, handle missing data).
- [ ] Integrate the `DataFetcher` component into the main application flow (`main.py`).
- [ ] Update `config.yaml` schema and parsing to include data source configuration.
- [ ] Update `.gitignore` to ignore the cache directory.

## Testing Requirements

**Guidance:** Verify implementation against the ACs using the following tests.

- **Unit Tests:**
  - Write unit tests for the `yfinance` wrapper, mocking the external API calls to test retry logic, timeouts, and error handling.
  - Write unit tests for the cache logic (save, load, check validity), using an in-memory SQLite database. Test cache hits, misses, partial data, and versioning checks.
- **Integration Tests:**
  - Write an integration test (`tests/integration/test_data_fetching_caching.py`) that uses a real (but small) set of symbols and date range, verifies data is fetched, saved to a temporary cache file, and then retrieved from the cache on a second call. Test error handling for a symbol that might fail.
- **Manual/CLI Verification:**
  - Run the system with a config specifying a few stocks and a date range. Verify console logs show fetching progress and cache creation.
  - Run the system again with the same config. Verify console logs show cache hits and faster execution.
  - Manually inspect the created SQLite cache file (optional, using a DB browser) to verify data structure and content.
- _(Hint: See `docs/testing-strategy.md` for the overall approach)_

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:** {Track changes _within this specific story file_ if iterations occur}
  - Initial Draft
